async function htmlWidget(t,e){const a=/^<([-A-Za-z0-9_]+)((?:\s+[a-zA-Z_:][-a-zA-Z0-9_:.]*(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,r=/^<\/([-A-Za-z0-9_]+)[^>]*>/,n=/([a-zA-Z_:][-a-zA-Z0-9_:.]*)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;function i(t){return t.split(",").reduce((t,e)=>(t[e]=!0,t),{})}const o=i("symbol,img,spacer,hr"),l=i("bottom-align-content,center-align-content,top-align-content,layout-vertically,layout-horizontally,container-relative-shape,resizable,apply-filling-content-mode,apply-fitting-content-mode,center-align-image,left-align-image,right-align-image,center-align-text,left-align-text,right-align-text,apply-date-style,apply-offset-style,apply-relative-style,apply-timer-style,apply-time-style");function s(t){return!!o[t]}class c{constructor(t,e){this.name=t,this.attributes=this.getAttributes(e)}getAttributes(t){let e={};return t.replace(n,function(t,a){const r=Array.prototype.slice.call(arguments),n=r[2]?r[2]:r[3]?r[3]:r[4]?r[4]:function(t){return!!l[t]}(a)?a:"";e[a]=n.replace(/(^|[^\\])"/g,'$1\\"')}),e}}class d extends c{constructor(t,e){super(t,e)}}class g{constructor(t){this.name=t}}class u{constructor(t){this.text=t}}const m="Element",p="Text";function f(t,e){switch(t){case m:return function(t){const e=t.name,a=t.attributes;return t instanceof d?{type:m,tagName:e,attributes:a}:{type:m,tagName:e,attributes:a,children:[]}}(e);case p:return function(t){const e=t.text;return{type:p,content:e}}(e)}}let h,b,y=-1,$=-1,w=-1,A=-1,k=-1,x=-1,O=-1;const S={widget:["background-color","background-gradient","background-image","refresh-after-date","spacing","url","padding","class","use-default-padding"],stack:["background-color","background-gradient","background-image","spacing","url","padding","class","border-color","border-width","corner-radius","size","bottom-align-content","center-align-content","top-align-content","layout-horizontally","layout-vertically","use-default-padding"],hr:["background-color","background-gradient","corner-radius","class","url","layout-horizontally","layout-vertically","width"],img:["border-color","border-width","container-relative-shape","corner-radius","image-opacity","image-size","resizable","tint-color","url","apply-filling-content-mode","apply-fitting-content-mode","center-align-image","left-align-image","right-align-image","src","class"],symbol:["border-color","border-width","container-relative-shape","corner-radius","image-opacity","image-size","resizable","tint-color","url","apply-filling-content-mode","apply-fitting-content-mode","center-align-image","left-align-image","right-align-image","named","class"],text:["font","line-limit","minimum-scale-factor","shadow-color","shadow-offset","shadow-radius","text-color","text-opacity","url","center-align-text","left-align-text","right-align-text","class"],date:["font","line-limit","minimum-scale-factor","shadow-color","shadow-offset","shadow-radius","text-color","text-opacity","url","center-align-text","left-align-text","right-align-text","class","apply-date-style","apply-offset-style","apply-relative-style","apply-timer-style","apply-time-style"]};let E=(v=t,function(t){let e={tag:"root",children:[]},a=[e];a.last=(()=>a[a.length-1]);for(let e=0;e<t.length;e++){const r=t[e];if(r instanceof c){const t=f(m,r);t.children?a.push(t):a.last().children.push(t)}else if(r instanceof g){let t=a[a.length-2],e=a.pop();t.children.push(e)}else r instanceof u?a.last().children.push(f(p,r)):"Comment"!=r.type||a.last().children.push(r)}return e}(function(t){let e=t,n=[];const i=Date.now()+1e3;for(;e;){if(0===e.indexOf("\x3c!--")){const t=e.indexOf("--\x3e")+3;n.push({type:"Comment",text:e.substring(4,t-3)}),e=e.substring(t);continue}if(0===e.indexOf("</")){const t=e.match(r);if(!t)continue;e=e.substring(t[0].length);const a=t[1];if(s(a))continue;n.push(new g(a));continue}if(0===e.indexOf("<")){const t=e.match(a);if(!t)continue;e=e.substring(t[0].length);const r=t[1],i=t[2],o=s(r)?new d(r,i):new c(r,i);n.push(o);continue}const t=e.indexOf("<"),o=t<0?e:e.substring(0,t);if(e=t<0?"":e.substring(t),n.push(new u(o)),Date.now()>=i)break}return n}(v))).children.filter(t=>{if("widget"==t.tagName)return t})[0];var v;if(!E)throw new Error("widget Tag Must Be The Parent Tag");let C=E.children.filter(t=>"style"==t.tagName),N="";for(let t of C)for(let e of t.children)"Text"==e.type&&(N+="\n"+e.content.trim());let z=[],I=N.match(/[\s\S]+?{[\s\S]*?}/g)||[];for(let t=0;t<I.length;t++){let e=I[t];if(!/^\s*(\.?[\w\-]+?|\*)\s*\{(\s*[\w\-]+\s*:\s*[^\n]+?\s*;)*?\s*([\w\-]+\s*:\s*[^\n]+\s*;?)?\s*\}/.test(e))throw new Error(`Invalid CSS Rule\n${e.trim()}`);let a=e.match(/\.?[\w\-]+|\*/)[0];z[t]={selector:a,css:{}},e.match(/\{([\s\S]*)\}/)[1].split(";").map(t=>t.trim()).filter(t=>t).forEach(e=>{z[t].css[e.split(/:/)[0].trim()]=e.substring(e.indexOf(":")+1).trim()})}await async function t(e){if("Text"==e.type||"style"==e.tagName)return;if("widget"==e.tagName&&!b){b="let widget = new ListWidget()";let a=["*","widget"],r={};for(let t of Object.keys(e.attributes)){let n=e.attributes[t].trim();if(!S.widget.includes(t))throw new Error(`Unknown Attribute ${t} On ${e.tagName} Element`);if("class"==t){n=n.trim().split(" ");for(let t of n)a.push("."+t)}else r[t]=n||!0}await M("widget","widget",a,r);for(let a of e.children)h="widget",await t(a);return}if("stack"==e.tagName){b+=`\nlet stack${++y} = ${h}.addStack()`;let a=["*","stack"],r={};for(let t of Object.keys(e.attributes)){let n=e.attributes[t].trim();if(!S.stack.includes(t))throw new Error(`Unknown Attribute ${t} On ${e.tagName} Element`);if("class"==t){n=n.trim().split(" ");for(let t of n)a.push("."+t)}else r[t]=n||!0}await M("stack","stack"+y,a,r);let n="stack"+y;for(let a of e.children)h=n,t(a);return}if("symbol"==e.tagName){b+=`\nlet symbol${++O} = ${h}.addImage(SFSymbol.named("${e.attributes.named?e.attributes.named:"questionmark.circle"}").image)`;let t=["*","symbol"],a={};for(let r of Object.keys(e.attributes)){let n=e.attributes[r].trim();if(!S.symbol.includes(r))throw new Error(`Unknown Attribute ${r} On ${e.tagName} Element`);if("class"==r){n=n.trim().split(" ");for(let e of n)t.push("."+e)}else"named"!=r&&(a[r]=n||!0)}return void await M("symbol","symbol"+O,t,a)}if("img"==e.tagName){if($++,!e.attributes.src)throw new Error("img Element Must Have A src Attribute");if(e.attributes.src.trim().startsWith("data:image/")){let t=e.attributes.src.trim();t=t.replace("data:image/png;base64,","").replace("data:image/jpeg;base64,",""),b+=`\nlet image${$} = ${h}.addImage(Image.fromData(Data.fromBase64String("${t.replace(/"/g,"")}")))`}else b+=`\nlet image${$} = ${h}.addImage(await new Request("${e.attributes.src.replace(/"/g,"")}").loadImage())`;let t=["*","img"],a={};for(let r of Object.keys(e.attributes)){let n=e.attributes[r].trim();if(!S.img.includes(r))throw new Error(`Unknown Attribute ${r} On ${e.tagName} Element`);if("class"==r){n=n.trim().split(" ");for(let e of n)t.push("."+e)}else"src"!=r&&(a[r]=n||!0)}return void await M("img","image"+$,t,a)}if("text"==e.tagName){w++;let t=[];for(let a of e.children)"Text"==a.type&&t.push(a.content.trim());b+=`\nlet text${w} = ${h}.addText("${t.join(" ").replace(/"/g,"").replace(/&lt;/g,"<").replace(/&gt/g,">").replace(/&amp;/g,"&").replace(/\n\s+/g,"\\n")}")`;let a=["*","text"],r={};for(let t of Object.keys(e.attributes)){let n=e.attributes[t].trim();if(!S.text.includes(t))throw new Error(`Unknown Attribute ${t} On ${e.tagName} Element`);if("class"==t){n=n.trim().split(" ");for(let t of n)a.push("."+t)}else r[t]=n||!0}return void await M("text","text"+w,a,r)}if("date"==e.tagName){k++;let t=[];for(let a of e.children)"Text"==a.type&&t.push(a.content.trim());b+=`\nlet date${k} = ${h}.addDate(new Date("${t.join("").replace(/"/g,"").replace(/&lt;/g,"<").replace(/&gt/g,">").replace(/&amp;/g,"&").replace(/\n\s+/g,"\\n").replace(/"/g,"")}"))`;let a=["*","date"],r={};for(let t of Object.keys(e.attributes)){let n=e.attributes[t].trim();if(!S.date.includes(t))throw new Error(`Unknown Attribute ${t} On ${e.tagName} Element`);if("class"==t){n=n.trim().split(" ");for(let t of n)a.push("."+t)}else r[t]=n||!0}return void await M("date","date"+k,a,r)}if("hr"==e.tagName){b+=`\nlet hr${++x} = ${h}.addStack()\nhr${x}.addSpacer()\nlet hrImage${x} = hr${x}.addImage(Image.fromData(Data.fromBase64String("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=")))\nhrImage${x}.imageSize = new Size(1,1)\nhr${x}.addSpacer()\nhr${x}.backgroundColor = Color.dynamic(Color.black(), Color.white())`;let t=["*","hr"],a={};for(let r of Object.keys(e.attributes)){let n=e.attributes[r].trim();if(!S.hr.includes(r))throw new Error(`Unknown Attribute ${r} On ${e.tagName} Element`);if("class"==r){n=n.trim().split(" ");for(let e of n)t.push("."+e)}else a[r]=n||!0}return void await M("hr","hr"+x,t,a)}if("spacer"==e.tagName)return void(b+=`\n${h}.addSpacer(${/\d+/.exec(e.attributes.space)?/\d+/.exec(e.attributes.space):""})`);if("Comment"==e.type)return void(e.text.match(/\n/g)?b+=`\n/*\n${e.text}\n*/`:b+=`\n// ${e.text}`);throw"widget"==e.tagName?new Error("widget Element Must Not Be Nestled"):new Error("Invalid Tag Name:"+e.tagName)}(E),1==e&&console.log(b);let P=new(0,Object.getPrototypeOf(async function(){}).constructor)(b+"\nreturn widget");return await P();async function M(t,e,a,r){let n={};for(let e of z)if(a.includes(e.selector))for(let a of Object.keys(e.css))S[t].includes(a)&&(n[a]=e.css[a]);for(let t of Object.keys(r))n[t]=r[t];for(let a of Object.keys(n)){let r="true"==n[a]||n[a];switch(a){case"background-color":await T(t,"background-color",r,e);break;case"background-gradient":await U(t,r,e);break;case"background-image":L(r,e);break;case"refresh-after-date":case"spacing":j(t,a,r,e);break;case"url":b+=`\n${e}.url = "${r.replace(/"/g,"")}"`;break;case"padding":F(t,r,e);break;case"border-color":await T(t,a,r,e);break;case"border-width":case"corner-radius":j(t,a,r,e);break;case"size":Z(t,a,r,e);break;case"use-default-padding":1==r&&(b+=`\n${e}.useDefaultPadding()`);break;case"bottom-align-content":1==r&&(b+=`\n${e}.bottomAlignContent()`);break;case"center-align-content":1==r&&(b+=`\n${e}.centerAlignContent()`);break;case"top-align-content":1==r&&(b+=`\n${e}.topAlignContent()`);break;case"layout-horizontally":1==r&&(b+="hr"!==t?`\n${e}.layoutHorizontally()`:`\nhr${e.exec(/\d+/)}.layoutHorizontally()\nhrImage${e.exec(/\d+/)}.imageSize = new Size(1,${n[width]?n[width]:1})`);break;case"layout-vertically":1==r&&(b+="hr"!==t?`\n${e}.layoutVertically()`:`\nhr${e.exec(/\d+/)}.layoutVertically()\nhrImage${e.exec(/\d+/)}.imageSize = new Size(${n[width]?n[width]:1},1)`);break;case"container-relative-shape":1==r&&(b+=`\n${e}.containerRelativeShape = true`);break;case"corner-radius":j(t,a,r,e);break;case"image-opacity":D(t,a,r,e);break;case"image-size":Z(t,a,r,e);break;case"resizable":1==r&&(b+=`\n${e}.resizable = false`);break;case"tint-color":await T(t,a,r,e);break;case"apply-filling-content-mode":1==r&&(b+=`\n${e}.applyFillingContentMode()`);break;case"apply-fitting-content-mode":1==r&&(b+=`\n${e}.applyFittingContentMode()`);break;case"center-align-image":1==r&&(b+=`\n${e}.centerAlignImage()`);break;case"left-align-image":1==r&&(b+=`\n${e}.leftAlignImage()`);break;case"right-align-image":1==r&&(b+=`\n${e}.rightAlignImage()`);break;case"font":R(t,r,e);break;case"line-limit":j(t,a,r,e);break;case"minimum-scale-factor":D(t,a,r,e);break;case"shadow-color":await T(t,a,r,e);break;case"shadow-offset":W(t,r,e);break;case"shadow-radius":j(t,a,r,e);break;case"text-color":await T(t,a,r,e);break;case"text-opacity":D(t,a,r,e);break;case"center-align-text":1==r&&(b+=`\n${e}.centerAlignText()`);break;case"left-align-text":1==r&&(b+=`\n${e}.leftAlignText()`);break;case"right-align-text":1==r&&(b+=`\n${e}.rightAlignText()`);break;case"apply-date-style":1==r&&(b+=`\n${e}.applyDateStyle()`);break;case"apply-offset-style":1==r&&(b+=`\n${e}.applyOffsetStyle()`);break;case"apply-relative-style":1==r&&(b+=`\n${e}.applyRelativeStyle()`);break;case"apply-timer-style":1==r&&(b+=`\n${e}.applyTimerStyle()`);break;case"apply-time-style":1==r&&(b+=`\n${e}.applyTimeStyle()`);break;case"width":b+=`\nhrImage${e.exec(/\d+/)}.imageSize = new Size(${1==n["layout-vertically"]?`1,${r}`:`${r},1`})`}}}async function B(t){let e=new WebView;return await e.loadHTML(`<div id="div"style="color:${t}"></div>`),function(t,e,a,r){t=t.toString(16),e=e.toString(16),a=a.toString(16),1==t.length&&(t="0"+t);1==e.length&&(e="0"+e);1==a.length&&(a="0"+a);r=r?1==r.length?",0"+r:","+r:"";return`new Color("${"#"+t+e+a}"${r})`}(...(await e.evaluateJavaScript('window.getComputedStyle(document.getElementById("div")).color')).match(/\d+(\.\d+)?/g).map(t=>Number(t)))}async function T(t,e,a,r){colours=a.split("-"),b+=`\n${r}.${e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e.toUpperCase())} = ${2==colours.length?"Color.dynamic("+await B(colours[0])+","+await B(colours[1])+")":await B(colours[0])}`}function j(t,e,a,r){if(!/^\s*\d+\s*$/.test(a))throw new Error(`${e} Propery Or Attribute Must Be A Positive Integer: ${a}`);b+="refresh-after-date"==e?`\nlet date = new Date()\ndate.setMinutes(date.getMinutes() + ${/\d+/.exec(a)})\nwidget.refreshAfterDate = date`:`\n${r}.${e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e.toUpperCase())} = ${/\d+/.exec(a)}`}function D(t,e,a,r){if(!/^\s*\d*(?:\.\d*)?%?\s*$/.test(a)&&"."!==/^\s*\d*(?:\.\d*)?%?\s*$/.exec(a))throw new Error(`${e} Propery Or Attribute Must Be A Positive Integer Or Float With An Optional  "%" At The End: ${a}`);(a=/\d*(?:\.\d*)?%?/.exec(a)[0]).endsWith("%")&&(a=Number(a.replace("%","")),a/=100),b+=`\n${r}.${e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e.toUpperCase())} = ${a}`}async function U(t,e,a){A++;let r,n=e;n=n.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map(t=>t.trim());const i={"to left":90,"to right":270,"to top":180,"to bottom":0,"to top left":135,"to top right":225,"to bottom left":45,"to bottom right":315,"to left top":135,"to right top":225,"to left bottom":45,"to right bottom":315};r=Object.keys(i).includes(n[0])?i[n.shift()]:/\d+\s*deg/.test(n[0])?Number(n.shift().match(/(\d+)\s*deg/)[1]):0;let o=[];for(let t of n)2==(t=(t=t.replace(/\d*(\.\d+)?%?$/,"")).split("-")).length?o.push(Color.dynamic(await B(t[0]),await B(t[1]))):o.push(await B(t[0]));let l=n.map(t=>/\d*(\.\d+)?%?$/.test(t)?t.match(/\d*(\.\d+)?%?$/)[0]:null).map(t=>(t&&t.endsWith("%")&&(t=Number(t.replace("%",""))/100),!isNaN(t)&&!isNaN(parseFloat(t))||"number"==typeof t?Number(t):null));l[0]||(l[0]=0),l[l.length-1]||(l[l.length-1]=1);let s=0;for(let t=0;t<l.length;t++){let a=l[t];if(a){if(s>a)throw new Error(`background-gradient Propery Or Attribute Locations Must Be In Ascending Order: ${e}`);if(a<0)throw new Error(`background-gradient Propery Or Attribute Locations Must Be Equal Or Greater Than 0: ${e}`);if(a>1)throw new Error(`background-gradient Propery Or Attribute Locations Must Be Equal Or Less Than 1: ${e}`);s=a}else{let e=0,a=t;for(;null===l[a];)e++,a++;let r=(l[a]-l[t-1])/(e+1);for(let a=0;a<e;a++)l[a+t]=r*(a+1)+l[t-1]}}b+=`\nlet gradient${A} = new LinearGradient()\ngradient${A}.colors = [${o}]\ngradient${A}.locations = [${l}]\ngradient${A}.startPoint = ${`new Point(${1-(.5+.5*Math.cos(Math.PI*(r+90)/180))}, ${1-(.5+.5*Math.sin(Math.PI*(r+90)/180))})`}\ngradient${A}.endPoint = ${`new Point(${.5+.5*Math.cos(Math.PI*(r+90)/180)}, ${.5+.5*Math.sin(Math.PI*(r+90)/180)})`}\n${a}.backgroundGradient = gradient${A}`}function F(t,e,a){if(!/^\s*\d+((\s*,\s*\d+){3}|(\s*,\s*\d+))?\s*$/g.test(e))throw new Error(`padding Propery Or Attribute Must Be 1, 2 Or 4 Positive Integers Separated By Commas: ${e}`);paddingArray=e.match(/\d+/g),1==paddingArray.length?paddingArray=[paddingArray[0],paddingArray[0],paddingArray[0],paddingArray[0]]:2==paddingArray.length&&(paddingArray=[paddingArray[0],paddingArray[1],paddingArray[0],paddingArray[1]]),b+=`\n${a}.setPadding(${paddingArray.join(",")})`}function L(t,e){t.startsWith("data:image/")?(t=t.replace("data:image/png;base64,","").replace("data:image/jpeg;base64,",""),b+=`\n${e}.backgroundImage = Image.fromData(Data.fromBase64String("${t.replace(/"/g,"")}"))`):b+=`\n${e}.backgroundImage = await new Request("${t.replace(/"/g,"")}").loadImage()`}function Z(t,e,a,r){if(!/^\s*\d+\s*,\s*\d+\s*$/.test(a))throw new Error(`${e} Propery Or Attribute Must Have 2 Positive Integers Separated By Commas: ${a}`);b+=`\n${r}.${e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e.toUpperCase())} = new Size(${a.match(/\d+/g)[0]},${a.match(/\d+/g)[1]})`}function R(t,e,a){if(!/^\s*[^,]+,\s*\d+\s*$/.test(e)&&!["body","callout","caption1","caption2","footnote","subheadline","headline","italicSystemFont","largeTitle","title1","title2","title3"].includes(e))throw new Error(`font Propery Or Attribute Must Be 1 font And 1 Positive Integer Separated By Commas Or A Content-Based Font: ${e}`);let r=/^\s*(((black|bold|medium|light|heavy|regular|semibold|thin|ultraLight)(MonospacedSystemFont|RoundedSystemFont|SystemFont)\s*,\s*(\d+))|(body|callout|caption1|caption2|footnote|subheadline|headline|largeTitle|title1|title2|title3)|((italicSystemFont)\s*,\s*(\d+)))\s*$/;r.test(e)?b+=`\n${a}.font = Font.${e.replace(r,"$3$4$6$8($5$9)")}`:b+=`\n${a}.font = new Font("${e.split(",")[0].replace(/"/g,"")}",${e.split(",")[1].match(/\d+/g)[0]})`}function W(t,e,a){if(!/^\s*-?\d+\s*,\s*-?\d+\s*$/.test(e))throw new Error(`shadow-offset Propery Or Attribute Element Must Have 2 Integers Separated By Commas: ${e}`);b+=`\n${a}.shadowOffset = new Point(${e.split(",")[0].match(/-?\d*/)[0]},${e.split(",")[1].match(/-?\d*/)[0]})`}}
