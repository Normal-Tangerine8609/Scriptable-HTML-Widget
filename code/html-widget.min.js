async function htmlWidget(t,e,a){let n,o="",i={},l=-1;const r={colour:{async add(t,e,a){const n=e.split("-");let o;if(2===n.length){const t=await Promise.allSettled([$(n[0]),$(n[1])]);o=`Color.dynamic(${t[0].value}, ${t[1].value})`}else o=await $(n[0]);h(`${a}.${t} = ${o}`)},validate(){}},posInt:{add(t,e,a){h("refreshAfterDate"===t?`let date = new Date()\ndate.setMinutes(date.getMinutes() + ${e})\nwidget.refreshAfterDate = date`:`${a}.${t} = ${e}`)},validate(t,e,a){/^\d+$/.test(a)||w("`{}` {} must be a positive integer: `{}`.",t,e,a)}},decimal:{add(t,e,a){e.endsWith("%")&&(e=Number(e.replace("%","")),e/=100),h(`${a}.${t} = ${e}`)},validate(t,e,a){/^\d*((\.\d+)|\d\.?)%?$/.test(a)||w("`{}` {} must be a positive integer or float with an optional `%` at the end: `{}`.",t,e,a)}},gradient:{async add(t,e,a){l++;let n,o=e.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));const i={"to left":90,"to right":270,"to top":180,"to bottom":0,"to top left":135,"to top right":225,"to bottom left":45,"to bottom right":315,"to left top":135,"to right top":225,"to left bottom":45,"to right bottom":315};n=o[0]in i?i[o.shift()]:/\d+\s*deg/.test(o[0])?Number(o.shift().match(/(\d+)\s*deg/)[1]):0;const r=[];for(const t of o){const e=t.replace(/\s+\d*((\.\d+)|\d\.?)%?$/,"").split("-");if(2==e.length){const t=await Promise.allSettled([$(e[0]),$(e[1])]);r.push(`Color.dynamic(${t[0].value}, ${t[1].value})`)}else r.push(await $(e[0]))}let s=o.map((t=>{let e=t.match(/\s+\d*((\.\d+)|\d\.?)%?$/),a=e&&e[0];return a&&a.endsWith("%")&&(a=Number(a.replace("%",""))/100),null===a?null:Number(a)}));null===s[0]&&(s[0]=0),null===s[s.length-1]&&(s[s.length-1]=1);for(let t=0;t<s.length;t++){let e=s[t],a=t+1;for(;a<s.length&&null===s[a];)a++;let n=(s[a]-s[t])/(a-t);for(let o=1;o<a-t;o++)s[t+o]=n*o+e}const d=1-(.5+.5*Math.cos(Math.PI*(n+90)/180)),c=1-(.5+.5*Math.sin(Math.PI*(n+90)/180)),u=.5+.5*Math.cos(Math.PI*(n+90)/180),g=.5+.5*Math.sin(Math.PI*(n+90)/180);h(`let gradient${l} = new LinearGradient()\ngradient${l}.colors = [${r}]\ngradient${l}.locations = [${s}]\ngradient${l}.startPoint = new Point(${d}, ${c})\ngradient${l}.endPoint = new Point(${u}, ${g})\n${a}.backgroundGradient = gradient${l}`)},validate(t,e,a){let n=a.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));(["to left","to right","to top","to bottom","to top left","to top right","to bottom left","to bottom right","to left top","to right top","to left bottom","to right bottom"].includes(n[0])||/\d+\s*deg/.test(n[0]))&&n.shift();let o=n.map((t=>{let e=t.match(/\s+\d*((\.\d+)|\d\.?)%?$/),a=e&&e[0];return a&&a.endsWith("%")&&(a=Number(a.replace("%",""))/100),null===a?null:Number(a)})),i=0;for(let n=0;n<o.length;n++){let l=o[n];l&&(i>l&&w("`{}` {} locations must be in ascending order: `{}`.",t,e,a),l<0&&w("`{}` {} locations must be equal or greater than `0`: `{}`.",t,e,a),l>1&&w("`{}` {} locations must be equal or less than `1`: `{}`.",t,e,a),i=l)}}},padding:{add(t,e,a){if("default"===e)h(`${a}.useDefaultPadding()`);else{let t=e.match(/\d+/g);1==t.length?t=[t[0],t[0],t[0],t[0]]:2==t.length&&(t=[t[0],t[1],t[0],t[1]]),h(`${a}.setPadding(${t.join(", ")})`)}},validate(t,e,a){/^(\d+((\s*,\s*\d+){3}|(\s*,\s*\d+))?|default)$/g.test(a)||w("`{}` {} must be 1, 2 or 4 positive integers separated by commas or be `default`: `{}`.",t,e,a)}},size:{add(t,e,a){let n=e.match(/\d+/g);h(`${a}.${t} = new Size(${n[0]}, ${n[1]})`)},validate(t,e,a){/^\d+\s*,\s*\d+$/.test(a)||w("`{}` {} must be 2 positive integers separated by commas: `{}`.",t,e,a)}},font:{add(t,e,a){let n=/^(((black|bold|medium|light|heavy|regular|semibold|thin|ultraLight)(MonospacedSystemFont|RoundedSystemFont|SystemFont)\s*,\s*(\d+))|(body|callout|caption1|caption2|footnote|subheadline|headline|largeTitle|title1|title2|title3)|((italicSystemFont)\s*,\s*(\d+)))$/;n.test(e)?h(`${a}.font = Font.${e.replace(n,"$3$4$6$8($5$9)")}`):h(`${a}.font = new Font("${e.split(",")[0].replace(/"/g,"")}",${e.split(",")[1].match(/\d+/g)[0]})`)},validate(t,e,a){/^[^,]+,\s*\d+$/.test(a)||["body","callout","caption1","caption2","footnote","subheadline","headline","italicSystemFont","largeTitle","title1","title2","title3"].includes(a)||w("`{}` {} must be 1 font name and 1 positive integer separated by commas or be a content-based font: `{}`.",t,e,a)}},point:{add(t,e,a){const n=e.split(",");h(`${a}.shadowOffset = new Point(${n[0]},${n[1]})`)},validate(t,e,a){/^-?\d+\s*,\s*-?\d+$/.test(a)||w("`{}` {} must be 2 integers separated by commas: `{}`.",t,e,a)}},bool:{add(t,e,a){"false"!==e&&h("resizable"===t?`${a}.resizable = false`:`${a}.${t} = true`)},validate(){}},url:{add:(t,e,a)=>{h(`${a}.url = "${e.replace(/"/g,"")}"`)},validate(t,e,a){/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/.test(a)||w("`{}` {} must be a valid URL: `{}.`",t,e,a)}},image:{add(t,e,a){e.startsWith("data:image/")?h(`${a}.backgroundImage = Image.fromData(Data.fromBase64String("${e.replace(/data:image\/\w+;base64,/,"").replace(/"/g,"")}"))`):h(`${a}.backgroundImage = await new Request("${e.replace(/"/g,"")}").loadImage()`)},validate(t,e,a){/^(https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*))|(data:image\/\w+?;base64,[a-zA-Z0-9+/]+={0,2})$/.test(a)||w("`{}` {} must be a valid url or base encoded data link: `{}`.",t,e,a)}},layout:{add(t,e,a){h(`${a}.layout${e[0].toUpperCase()+e.slice(1)}()`)},validate(t,e,a){"vertically"!==a&&"horizontally"!==a&&w("`{}` {} must be `vertically` or `horizontally`: `{}`.",t,e,a)}},alignText:{add(t,e,a){h(`${a}.${e}AlignText()`)},validate(t,e,a){["center","left","right"].includes(a)||w("`{}` {} must be `left`, `right` or `center`: `{}.`",t,e,a)}},alignImage:{add(t,e,a){h(`${a}.${e}AlignImage()`)},validate(t,e,a){["center","left","right"].includes(a)||w("`{}` {} must be `left`, `right` or `center`: `{}`.",t,e,a)}},alignContent:{add(t,e,a){h(`${a}.${e}AlignContent()`)},validate(t,e,a){["center","top","bottom"].includes(a)||w("`{}` {} must be `top`, `bottom` or `center`: `{}`.",t,e,a)}},applyStyle:{add(t,e,a){h(`${a}.apply${e[0].toUpperCase()+e.slice(1)}Style()`)},validate(t,e,a){["date","timer","offset","relative","time"].includes(a)||w("`{}` {} must be `date`, `timer` , `relative`, `time`, or `offset`: `{}`.",t,e,a)}},contentMode:{add(t,e,a){h(`${a}.apply${e[0].toUpperCase()+e.slice(1)}ContentMode()`)},validate(t,e,a){["filling","fitting"].includes(a)||w("`{}` {} must be `filling` or `fitting`: `{}`.",t,e,a)}}},s=u(t).children.find((t=>"widget"==t.name));s||w("`widget` tag must be the root tag.");const d=function(t){const e=[],a=t.match(/[\s\S]+?{[\s\S]*?}/g)||[];for(let t of a){/^\s*(([a-zA-Z]*?)(\.?[\w\-]+)*[\w\-]|\*)(\s*[,>]\s*(([a-zA-Z]*?)(\.?[\w\-]+)*[\w\-]|\*))*\s*\{(\s*[\w\-]+\s*:\s*[^\n]+?\s*;)*?\s*([\w\-]+\s*:\s*[^\n]+\s*;?)?\s*\}/.test(t)||w("Invalid CSS rule: `{}`.",t.trim());const a={},n=t.match(/\{([\s\S]*)\}/)[1].split(";");for(let t of n){if(t=t.trim(),!t)continue;const e=t.split(/:/)[0].trim(),n=t.split(/:/).splice(1).join(":").trim();a[b(e)]=n}t.split("{")[0].split(",").forEach((t=>e.push({selector:g(t),css:a})))}return e}(s.children.filter((t=>"style"==t.name)).map((t=>t.innerText)).join("\n"));!function t(e,a){if("style"==e.name)return;for(let t of a)m(e,t,0);if(e.children)for(let n of e.children)t(n,a)}(s,d),await async function t(e){if("style"==e.name)return;"widget"==e.name&&o&&w("`widget` tag must not be nestled.");o&&h("");e.name in i?i[e.name]+=1:i[e.name]=0;const l=i[e.name],s=e.innerText.replace(/&lt;/g,"<").replace(/&gt/g,">").replace(/&amp;/g,"&").replace(/\n\s+/g,"\\n"),d={};Object.entries(e.attrs).forEach((([t,e])=>{["class","no-css","children"].includes(t)||(d[b(t)]=e.trim())}));let c={};e.css&&!("no-css"in e.attrs)&&e.css.forEach((t=>Object.entries(t.css).forEach((([t,e])=>c[t]=e))));if(c={...c,...d},"spacer"===e.name){h(`let spacer${l} = ${n}.addSpacer(${d.space&&"null"!==d.space?d.space:""})`);f(d,c,{space:"posInt"})}else if("widget"===e.name){o+="let widget = new ListWidget()";const m={background:["gradient","image","colour"],refreshAfterDate:"posInt",spacing:"posInt",url:"url",padding:"padding",addAccessoryWidgetBackground:"bool"};f(d,c,m);for(const[y,v]of Object.entries(c)){if("null"===v)continue;const S="widget";if("background"===y)try{r.url.validate("background",!0,v),r.image.add(y,v,S)}catch(I){1===v.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).length?await r.colour.add("backgroundColor",v,S):await r.gradient.add("backgroundGradient",v,S)}else{const C=r[m[y]].add;await C(y,v,S)}}const $=o.split("\n").length;for(const k of e.children)n="widget",await t(k);p($)}else if("stack"===e.name){h(`let stack${l} = ${n}.addStack()`);const z={background:["gradient","image","colour"],spacing:"posInt",url:"url",padding:"padding",borderColor:"colour",borderWidth:"posInt",size:"size",cornerRadius:"posInt",alignContent:"alignContent",layout:"layout"};f(d,c,z);for(const[M,O]of Object.entries(c)){if("null"===O)continue;const T="stack"+l;if("background"===M)try{r.image.validate("background",!0,O),r.image.add(M,O,T)}catch(P){1===O.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).length?await r.colour.add("backgroundColor",O,T):await r.gradient.add("backgroundGradient",O,T)}else{const j=r[z[M]].add;await j(M,O,T)}}const A=o.split("\n").length,x="stack"+l;for(let W of e.children)n=x,await t(W);p(A)}else if("img"===e.name){let R;d.src&&"null"!==d.src||w("`img` tag must have a `src` attribute."),R=d.src.startsWith("data:image/")?`Image.fromData(Data.fromBase64String("${d.src.replace(/data:image\/.*?;base64,/,"").replace(/"/g,"")}"))`:`await new Request("${d.src.replace(/"/g,"")}").loadImage()`,h(`let img${l} = ${n}.addImage(${R})`);const D={src:"image",url:"url",borderColor:"colour",borderWidth:"posInt",cornerRadius:"posInt",imageSize:"size",imageOpacity:"decimal",tintColor:"colour",resizable:"bool",containerRelativeShape:"bool",contentMode:"contentMode",alignImage:"alignImage"};f(d,c,D);for(const[E,Z]of Object.entries(c)){if("null"===Z||"src"===E)continue;const F="img"+l,L=r[D[E]].add;await L(E,Z,F)}}else if("text"===e.name){h(`let text${l} = ${n}.addText("${s.replace(/"/g,"")}")`);const N={url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText"};f(d,c,N);for(const[U,_]of Object.entries(c)){if("null"===_)continue;const q="text"+l,B=r[N[U]].add;await B(U,_,q)}}else if("date"===e.name){h(`let date${l} = ${n}.addDate(new Date("${s.replace(/"/g,"")}"))`);const G={url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText",applyStyle:"applyStyle"};f(d,c,G);for(const[H,J]of Object.entries(c)){if("null"===J)continue;const V="date"+l,X=r[G[H]].add;await X(H,J,V)}}else{e.name in a||w("Invalid tag name: `{}`.",e.name),h(`// <${e.name}>`);const K=a[e.name];f(d,c,K.mapping||{});for(let Q in K.mapping)Q in c||(c[Q]="null"),Q in d||(d[Q]="null");async function g(a){let i=u(a);i.children=i.children.map((t=>s(t,e.children)));let l=n;const r=o.split("\n").length;for(let e of i.children)n=l,await t(e);function s(t,e){if(t.children&&t.children.map((t=>{s(t,e)})),"children"in t.attrs)for(let a of e)t.children.push(a);return t.attrs["no-css"]="",t}p(r)}await K.render(g,c,d,s),h(`// </${e.name}>`)}}(s),h("// Widget Complete"),1==e&&console.log(o);const c=new(0,Object.getPrototypeOf((async function(){})).constructor)(o+"\nreturn widget");return await c();function u(t){const e=new XMLParser(t),a={isRoot:!0,name:"root",children:[]};let n=a;const o={};return e.didStartElement=(t,e)=>{const a=Symbol();o[a]=n;const i={name:t,attrs:e,innerText:"",children:[],end:a};n.children.push(i),n=i},e.foundCharacters=t=>{n.innerText+=""===n.innerText?t:" "+t},e.didEndElement=()=>{const t=n.end;n=o[t]},e.parseErrorOccurred=()=>{w("A parse error occurred, ensure your widget is formatted properly.")},e.parse(),a.isRoot||w("A parse error occurred, ensure all self closing tags are closed: <{}>.",a.name),n.isRoot||w("A parse error occurred, ensure all self closing tags are closed: <{}/>.",n.name),a}function g(t){t=t.trim();let e=0;const a=[];for(a.push({classes:[]});e<t.length;){let n=t[e];if("."===n){n=t[++e];const o=/[-a-zA-Z_0-9]/;o.test(n)||w("A css parse error occurred, a class name must be provided: `{}`.",t);let i="";for(;n&&o.test(n);)i+=n,n=t[++e];a.at(-1).classes.push(i)}const o=/ /;if(/>/.test(n)){for(n=t[++e];n&&o.test(n);)n=t[++e];a.push({classes:[]})}const i=/[a-z]/i;if(i.test(n)){let o="";for(;n&&i.test(n);)o+=n,n=t[++e];a.at(-1).tag=o}/\*/.test(n)&&(n=t[++e],a.at(-1).tag="*"),o.test(n)&&(n=t[++e])}return a}function m(t,e,a){if("style"!==t.name){for(let n of e.selector[a].classes){if(!t.attrs.class)return;if(!t.attrs.class.split(" ").includes(n))return}if(!e.selector[a].tag||"*"===e.selector[a].tag||e.selector[a].tag===t.name)if(e.selector.length-1===a)t.css||(t.css=[]),t.css.push(e);else if(t.children)for(let n of t.children)m(n,e,a+1)}}function f(t,e,a){for(const e in t)if("null"!==t[e])if(a[e]||w("Unknown attribute: `{}`.",e),"string"==typeof a[e])r[a[e]].validate(e,"attribute",t[e]);else{let n=!1;for(let o of a[e])try{r[o].validate(e,"attribute",t[e]),n=!0}catch(t){}n||w("`{}` attribute must be a {} type: `{}`",e,a[e].join(", ").replace(/,([^,]*?)$/," or$1"),t[e])}for(let t in e)if("null"!==e[t])if(a[t])if("string"==typeof a[t])r[a[t]].validate(t,"property",e[t]);else{let n=!1;for(let o of a[t])try{r[o].validate(t,"property",e[t]),n=!0}catch(t){}n||w("`{}` property must be a {} type: `{}`.",attr,a[t].join(", ").replace(/,([^,]*?)$/," or$1"),e[t])}else delete e[t]}function p(t){const e=o.split("\n");for(let a=e.length-1;a>=t;a--)e[a]=" "+e[a];o=e.join("\n")}function h(t){o+=`\n${t}`}async function $(t){let e=new WebView;return await e.loadHTML(`<div id="div"style="color:${t}"></div>`),function(t,e,a,n){t=t.toString(16),e=e.toString(16),a=a.toString(16),1==t.length&&(t="0"+t);1==e.length&&(e="0"+e);1==a.length&&(a="0"+a);n=n?1==n.length?",0"+n:","+n:"";return`new Color("${"#"+t+e+a}"${n})`}(...(await e.evaluateJavaScript('window.getComputedStyle(document.getElementById("div")).color')).match(/\d+(\.\d+)?/g).map((t=>Number(t))))}function b(t){return t.replace(/-(.)/g,((t,e)=>e.toUpperCase()))}function w(t,...e){for(let a of e)t=t.replace("{}",a);throw new Error(`HTML Widget Error\n--------<Code>--------\n${o}\n--------</Code>--------\n${t}`)}}module.exports=htmlWidget;