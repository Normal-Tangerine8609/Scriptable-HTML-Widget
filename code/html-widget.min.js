async function htmlWidget(t,e=!1,a={}){let n="widget",i="",o={},s=-1,r=0;const l=new Map,c=["font","lineLimit","minimumScaleFactor","shadowColor","shadowOffset","shadowRadius","textColor","textOpacity","alignText"],{root:d,styleTags:p}=f(t),u=d.children.find((t=>"widget"==t.name));u||T("`widget` tag must be the root tag.");!function(t,e){!function t(e,a,n){const i={...n},o=[{selector:"*",css:i}],s=[];for(const t of a){t.partial||s.push(t);const[a,...n]=t.selector;if($(e,a))if(n.length)s.push({selector:n,css:t.css,partial:!0});else{for(const e in t.css)c.includes(e)&&(i[e]=t.css[e]);o.push(t)}}e.css=o;for(const a of e.children||[])t(a,s,i)}(t,e,{})}(u,function(t){const e=[],a=/([^{]+)\{([^}]+)\}/g;let n;for(;n=a.exec(t);){const t=n[1].trim(),a=n[2].trim().split(";").map((t=>t.trim())).filter((t=>t.length)).reduce(((t,e)=>{const[a,...n]=e.split(":"),i=A(a.trim()),o=n.join(":").trim();return t[i]="null"===o?null:o,t}),{});t.split(",").map((t=>t.trim())).forEach((t=>{e.push({selector:h(t),css:a})}))}return e}(p.map((t=>t.innerText)).join("\n")));const g={colour:{async add(t,e,a){const[n,i]=e.split("-").map((t=>t.trim()));let o;if(null!=i){const[t,e]=await Promise.all([k(n),k(i)]);o=`Color.dynamic(${t}, ${e})`}else o=await k(n);I(`${a}.${t} = ${o}`)},validate(){}},posInt:{add(t,e,a){I("refreshAfterDate"===t?`${a}.refreshAfterDate = new Date(Date.now() + ${e} * 60000)`:`${a}.${t} = ${e}`)},validate(t,e,a){/^\d+$/.test(a)||T("`{}` {} must be a positive integer: `{}`.",t,e,a)}},decimal:{add(t,e,a){let n=parseFloat(e.replace("%",""));e.endsWith("%")&&(n/=100),I(`${a}.${t} = ${n}`)},validate(t,e,a){const n=a.endsWith("%")?a.slice(0,-1):a,i=parseFloat(n);(!Number.isFinite(i)||i<0)&&T("`{}` {} must be a positive integer or float with an optional `%` at the end: `{}`.",t,e,a)}},gradient:{async add(t,e,a){s++;let n,i=e.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));const o={"to top":0,"to top right":45,"to right":90,"to bottom right":135,"to bottom":180,"to bottom left":225,"to left":270,"to top left":315},r=i[0].toLowerCase();r in o?(i.shift(),n=o[r]):/\d+\s*deg/.test(r)?(i.shift(),n=Number(r.match(/(\d+)\s*deg/)[1])):n=0;const l=[],c=[];for(const t of i){const e=t.match(/\s+(\d+(?:\.\d+)?%?)$/);let a,n=null,i=t;if(e){const a=e[1];n=a.endsWith("%")?Number(a.slice(0,-1))/100:Number(a),i=t.slice(0,e.index).trim()}c.push(n);const[o,s]=i.split("-");if(null!=s){const[t,e]=await Promise.all([k(o),k(s)]);a=`Color.dynamic(${t}, ${e})`}else a=await k(o);l.push(a)}null===c[0]&&(c[0]=0),null===c.at(-1)&&(c[c.length-1]=1);for(let t=0;t<c.length;t++){let e=c[t],a=t+1;for(;a<c.length&&null===c[a];)a++;let n=(c[a]-c[t])/(a-t);for(let i=1;i<a-t;i++)c[t+i]=n*i+e}const d=Math.PI*(n-90)/180,p=Math.cos(d),u=Math.sin(d),g=.5/Math.max(Math.abs(p),Math.abs(u)),m=.5-g*p,f=.5-g*u,h=.5+g*p,$=.5+g*u;I(`let gradient${s} = new LinearGradient()`),I(`gradient${s}.colors = [${l}]`),I(`gradient${s}.locations = [${c}]`),I(`gradient${s}.startPoint = new Point(${m}, ${f})`),I(`gradient${s}.endPoint = new Point(${h}, ${$})`),I(`${a}.backgroundGradient = gradient${s}`)},validate(t,e,a){let n=a.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));(["to top","to top right","to right","to bottom right","to bottom","to bottom left","to left","to top left"].includes(n[0].toLowerCase())||/\d+\s*deg/.test(n[0]))&&n.shift(),n.length<2&&T("`{}` {} must have at least two color stops after the direction: `{}`.",t,e,a);let i=-1/0;for(const o of n){const n=o.match(/\s+(\d+(?:\.\d+)?%?)$/);if(n){const o=n[1],s=o.endsWith("%")?Number(o.slice(0,-1))/100:Number(o);Number.isFinite(s)||T("`{}` {} has invalid position: `{}` in `{}`.",t,e,o,a),(s<0||s>1)&&T("`{}` {} position must be between `0` and `1`: `{}`.",t,e,o),s<i&&T("`{}` {} color-stop positions must be in ascending order: `{}`.",t,e,a),i=s}}}},padding:{add(t,e,a){if("default"===e)return void I(`${a}.useDefaultPadding()`);const n=e.split(",").map((t=>parseInt(t.trim(),10)));let[i,o,s,r]=n;1===n.length?[i,o,s,r]=[i,i,i,i]:2===n.length?[i,o,s,r]=[i,o,i,o]:3===n.length&&([i,o,s,r]=[i,o,s,o]),I(`${a}.setPadding(${i}, ${o}, ${s}, ${r})`)},validate(t,e,a){if("default"===a)return;const n=a.split(",").map((t=>t.trim()));(n.length<1||n.length>4)&&T("`{}` {} must have 1-4 comma-separated positive integers or be `default`: `{}`.",t,e,a);for(let i of n)/^\d+$/.test(i)||T("`{}` {} must be non-negative integers: `{}` contains `{}`.",t,e,a,i)}},size:{add(t,e,a){let[n,i]=e.split(",");I(`${a}.${t} = new Size(${n}, ${i})`)},validate(t,e,a){/^\d+\s*,\s*\d+$/.test(a)||T("`{}` {} must be 2 positive integers separated by commas: `{}`.",t,e,a)}},font:{add(t,e,a){let n=/^(((black|bold|medium|light|heavy|regular|semibold|thin|ultraLight)(MonospacedSystemFont|RoundedSystemFont|SystemFont)\s*,\s*(\d+))|(body|callout|caption1|caption2|footnote|subheadline|headline|largeTitle|title1|title2|title3)|((italicSystemFont)\s*,\s*(\d+)))$/;if(n.test(e))I(`${a}.font = Font.${e.replace(n,"$3$4$6$8($5$9)")}`);else{const[t,n]=e.split(",");I(`${a}.font = new Font("${t.replace(/"/g,"")}",${n.match(/\d+/g)[0]})`)}},validate(t,e,a){/^[^,]+,\s*\d+$/.test(a)||["body","callout","caption1","caption2","footnote","subheadline","headline","italicSystemFont","largeTitle","title1","title2","title3"].includes(a)||T("`{}` {} must be 1 font name and 1 positive integer separated by commas or be a content-based font: `{}`.",t,e,a)}},point:{add(t,e,a){const[n,i]=e.split(",");I(`${a}.shadowOffset = new Point(${n},${i})`)},validate(t,e,a){/^-?\d+\s*,\s*-?\d+$/.test(a)||T("`{}` {} must be 2 integers separated by commas: `{}`.",t,e,a)}},bool:{add(t,e,a){"false"!==e&&I("resizable"===t?`${a}.resizable = false`:`${a}.${t} = true`)},validate(){}},url:{add:(t,e,a)=>{I(`${a}.url = "${e.replace(/"/g,"")}"`)},validate(t,e,a){/^\w+:\/\/\S+$/.test(a)||T("`{}` {} must be a valid URL: `{}.`",t,e,a)}},image:{add(t,e,a){e.startsWith("data:image/")?I(`${a}.backgroundImage = Image.fromData(Data.fromBase64String("${e.split(",",2)[1].replace(/"/g,"")}"))`):I(`${a}.backgroundImage = await new Request("${e.replace(/"/g,"")}").loadImage()`)},validate(t,e,a){/^(https?:\/\/\S+|data:image\/\w+?;base64,[a-zA-Z0-9+/]+=*)$/.test(a)||T("`{}` {} must be a valid url or base encoded data link: `{}`.",t,e,a)}},layout:{add(t,e,a){I(`${a}.layout${x(e)}()`)},validate(t,e,a){"vertically"!==a&&"horizontally"!==a&&T("`{}` {} must be `vertically` or `horizontally`: `{}`.",t,e,a)}},alignText:{add(t,e,a){I(`${a}.${e}AlignText()`)},validate(t,e,a){["center","left","right"].includes(a)||T("`{}` {} must be `left`, `right` or `center`: `{}.`",t,e,a)}},alignImage:{add(t,e,a){I(`${a}.${e}AlignImage()`)},validate(t,e,a){["center","left","right"].includes(a)||T("`{}` {} must be `left`, `right` or `center`: `{}`.",t,e,a)}},alignContent:{add(t,e,a){I(`${a}.${e}AlignContent()`)},validate(t,e,a){["center","top","bottom"].includes(a)||T("`{}` {} must be `top`, `bottom` or `center`: `{}`.",t,e,a)}},applyStyle:{add(t,e,a){I(`${a}.apply${x(e)}Style()`)},validate(t,e,a){["date","timer","offset","relative","time"].includes(a)||T("`{}` {} must be `date`, `timer` , `relative`, `time`, or `offset`: `{}`.",t,e,a)}},contentMode:{add(t,e,a){I(`${a}.apply${x(e)}ContentMode()`)},validate(t,e,a){["filling","fitting"].includes(a)||T("`{}` {} must be `filling` or `fitting`: `{}`.",t,e,a)}}};await b(u),I("// Widget Complete"),e&&console.log(i);const m=new(0,Object.getPrototypeOf((async function(){})).constructor)(i+"\nreturn widget");return await m();function f(t){const e=[],a=new XMLParser(t),n={name:"root",children:[]},i=[n];return a.didStartElement=(t,a)=>{const n={name:t,attrs:a,innerText:"",children:[],classList:[],noCss:!1,putChildren:!1};"style"===t?e.push(n):i.at(-1).children.push(n),i.push(n)},a.foundCharacters=t=>{i.at(-1).innerText+=t},a.didEndElement=()=>{const t=i.pop(),e={};for(const[a,n]of Object.entries(t.attrs)){const i=A(a);if("class"===i)t.classList=t.attrs.class.trim().split(/\s+/);else if("noCss"===i)t.noCss=!0;else if("children"===i)t.putChildren=!0;else{const t=n.trim();e[i]="null"===t?null:t}}t.attrs=e,0===i.length&&T("Unexpected closing tag: <{}/>",t.name)},a.parseErrorOccurred=t=>{T("A parse error occurred: {}",t)},a.parse(),1!==i.length&&T("A parse error occurred, ensure all tags are closed and attributes are properly formatted: <{}>",i.at(-1).name),{root:n,styleTags:e}}function h(t){return t.replace(/\s/g,"").split(">").filter((t=>t.length)).map((t=>{let e,a=t;if(!t.startsWith(".")){const n=t.match(/^([a-zA-Z][\w-]*|\*)/);n?(e=n[1],a=t.slice(e.length)):T("A css parse error occurred, invalid tag name: {}.",t)}const n=[];let i;const o=/\.([-_a-zA-Z0-9]+)/g;for(;i=o.exec(a);)n.push(i[1]);return{tag:e,classes:n}}))}function $(t,{tag:e,classes:a}){return(!e||"*"===e||t.name===e)&&a.every((e=>t.classList.includes(e)))}async function b(t){"widget"==t.name&&i&&T("`widget` tag must not be nestled."),i&&I(""),t.name in o?o[t.name]+=1:o[t.name]=0;const e=o[t.name],s=t.innerText.replace(/&lt;/g,"<").replace(/&gt/g,">").replace(/&amp;/g,"&").replace(/\n\s+/g,"\\n"),l=function(t=[],e,a){if(a)return{...e};const n={};for(const{css:e}of t)Object.assign(n,e);return{...n,...e}}(t.css,t.attrs,t.noCss),c={widget:{mapping:{background:["gradient","image","colour"],refreshAfterDate:"posInt",spacing:"posInt",url:"url",padding:"padding",addAccessoryWidgetBackground:"bool"},hasChildren:!0,instantiate:()=>(I("let widget = new ListWidget()"),"widget"),async applyStyles(e){const{background:a,...n}=l,i=a in t.attrs?"attribute":"property";await w("widget",i,a),await y(e,n,this.mapping)}},stack:{mapping:{background:["gradient","image","colour"],spacing:"posInt",url:"url",padding:"padding",borderColor:"colour",borderWidth:"posInt",size:"size",cornerRadius:"posInt",alignContent:"alignContent",layout:"layout"},hasChildren:!0,instantiate:()=>(I(`let stack${e} = ${n}.addStack()`),`stack${e}`),async applyStyles(e){const{background:a,...n}=l,i=a in t.attrs?"attribute":"property";await w(e,i,a),await y(e,n,this.mapping)}},spacer:{mapping:{space:"posInt"},hasChildren:!1,instantiate(){const a=t.attrs.space??"";return I(`let spacer${e} = ${n}.addSpacer(${a})`),null}},text:{mapping:{url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText"},hasChildren:!1,instantiate:()=>(I(`let text${e} = ${n}.addText("${s.replace(/"/g,"")}")`),`text${e}`),async applyStyles(t){await y(t,l,this.mapping)}},date:{mapping:{url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText",applyStyle:"applyStyle"},hasChildren:!1,instantiate:()=>(I(`let date${e} = ${n}.addDate(new Date("${s.replace(/"/g,"")}"))`),`date${e}`),async applyStyles(t){await y(t,l,this.mapping)}},img:{mapping:{src:"image",url:"url",borderColor:"colour",borderWidth:"posInt",cornerRadius:"posInt",imageSize:"size",imageOpacity:"decimal",tintColor:"colour",resizable:"bool",containerRelativeShape:"bool",contentMode:"contentMode",alignImage:"alignImage"},hasChildren:!1,instantiate(){let a;return t.attrs.src||T("`img` tag must have a `src` attribute."),a=t.attrs.src.startsWith("data:image/")?`Image.fromData(Data.fromBase64String("${t.attrs.src.replace(/data:image\/.*?;base64,/,"").replace(/"/g,"")}"))`:`await new Request("${t.attrs.src.replace(/"/g,"")}").loadImage()`,I(`let img${e} = ${n}.addImage(${a})`),`img${e}`},async applyStyles(t){const{src:e,...a}=l;await y(t,a,this.mapping)}}},d=c[t.name];if(!d){t.name in a||T("Invalid tag name: `{}`.",t.name),I(`// <${t.name}>`);const e=a[t.name],i=e.mapping||{};C(t.attrs,l,i);for(let e in i)e in l||(l[e]=null),e in t.attrs||(t.attrs[e]=null);const o=e=>async function(t,e){let{root:a}=f(t);a.children.forEach((t=>v(t,e))),r++;const i=n;for(let t of a.children)n=i,await b(t);r--}(e,t.children);return await e.render(o,l,t.attrs,s),void I(`// </${t.name}>`)}const p=d.instantiate();if(C(t.attrs,l,d.mapping),await(d.applyStyles?.(p)),d.hasChildren){r++;const e=n;n=p;for(const e of t.children)await b(e);r--,n=e}}async function y(t,e,a){for(const[n,i]of Object.entries(e)){if(null===i)continue;const e=a[n];await g[e].add(n,i,t)}}async function w(t,e,a){if(a)try{g.url.validate("background","attribute",a),g.image.add("background",a,t)}catch{1===a.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).length?await g.colour.add("backgroundColor",a,t):(g.gradient.validate("backgroundGradient",e,a),await g.gradient.add("backgroundGradient",a,t))}}function v(t,e){t.noCss=!0;for(let a of t.children||[])v(a,e);t.putChildren&&t.children.push(...e)}function C(t,e,a){S(t,a,"attribute"),S(e,a,"property")}function S(t,e,a){for(const[n,i]of Object.entries(t)){const o=e[n];if(!o){if("property"===a){delete t[n];continue}T("Unknown attribute: `{}`.",n)}if(null===i)continue;if(!Array.isArray(o)){g[o].validate(n,a,i);continue}if(!o.some((t=>{try{return g[t].validate(n,a,i),!0}catch{return!1}}))){const t=o.join(", ").replace(/,([^,]+)$/," or$1");T("`{}` {} must be {} type: `{}`",n,a,t,i)}}}function I(t){const e=" ".repeat(r);i+=`\n${e+t}`}function x(t){return t[0].toUpperCase()+t.slice(1)}async function k(t){if(l.has(t))return l.get(t);if(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t))return`new Color("${t}")`;let e=new WebView;await e.loadHTML(`<div id="div"style="color:${t}"></div>`);const a=function(t,e,a,n=1){const i=t=>t.toString(16).padStart(2,"0"),o=1===n?"":`,${n}`;return`new Color("#${i(t)}${i(e)}${i(a)}"${o})`}(...(await e.evaluateJavaScript('window.getComputedStyle(document.getElementById("div")).color')).match(/\d+(\.\d+)?/g).map(Number));return l.set(t,a),a}function A(t){return t.replace(/-(.)/g,((t,e)=>e.toUpperCase()))}function T(t,...e){for(let a of e)t=t.replace("{}",a);throw new Error(`HTML Widget Error\n--------<Code>--------\n${i}\n--------</Code>--------\n${t}`)}}module.exports=htmlWidget;