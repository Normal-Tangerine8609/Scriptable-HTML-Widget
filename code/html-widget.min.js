async function htmlWidget(t,e=!1,a={}){let n="widget",i="",o={},r=-1,s=0;const l=new Map,{root:c,styleTags:d}=m(t),p=c.children.find((t=>"widget"==t.name));p||W("`widget` tag must be the root tag.");!function(t,e){!function t(a,n){const i=[],o=[];h(a,e,i,o),h(a,n,i,o),a.css=i;for(const e of a.children||[])t(e,o)}(t,[])}(p,function(t){const e=[],a=/([^{]+)\{([^}]+)\}/g;let n;for(;n=a.exec(t);){const t=n[1].trim(),a=n[2].trim().split(";").map((t=>t.trim())).filter((t=>t.length)).reduce(((t,e)=>{const[a,...n]=e.split(":"),i=T(a.trim()),o=n.join(":").trim();return t[i]=o,t}),{});t.split(",").map((t=>t.trim())).forEach((t=>{e.push({selector:f(t),css:a})}))}return e}(d.map((t=>t.innerText)).join("\n")));const u={colour:{async add(t,e,a){const[n,i]=e.split("-").map((t=>t.trim()));let o;if(null!=i){const[t,e]=await Promise.all([k(n),k(i)]);o=`Color.dynamic(${t}, ${e})`}else o=await k(n);I(`${a}.${t} = ${o}`)},validate(){}},posInt:{add(t,e,a){I("refreshAfterDate"===t?`${a}.refreshAfterDate = new Date(Date.now() + ${e} * 60000)`:`${a}.${t} = ${e}`)},validate(t,e,a){/^\d+$/.test(a)||W("`{}` {} must be a positive integer: `{}`.",t,e,a)}},decimal:{add(t,e,a){let n=parseFloat(e.replace("%",""));e.endsWith("%")&&(n/=100),I(`${a}.${t} = ${n}`)},validate(t,e,a){const n=a.endsWith("%")?a.slice(0,-1):a,i=parseFloat(n);(!Number.isFinite(i)||i<0)&&W("`{}` {} must be a positive integer or float with an optional `%` at the end: `{}`.",t,e,a)}},gradient:{async add(t,e,a){r++;let n,i=e.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));const o={"to top":0,"to top right":45,"to right":90,"to bottom right":135,"to bottom":180,"to bottom left":225,"to left":270,"to top left":315},s=i[0].toLowerCase();s in o?(i.shift(),n=o[s]):/\d+\s*deg/.test(s)?(i.shift(),n=Number(s.match(/(\d+)\s*deg/)[1])):n=0;const l=[],c=[];for(const t of i){const e=t.match(/\s+(\d+(?:\.\d+)?%?)$/);let a,n=null,i=t;if(e){const a=e[1];n=a.endsWith("%")?Number(a.slice(0,-1))/100:Number(a),i=t.slice(0,e.index).trim()}c.push(n);const[o,r]=i.split("-");if(null!=r){const[t,e]=await Promise.all([k(o),k(r)]);a=`Color.dynamic(${t}, ${e})`}else a=await k(o);l.push(a)}null===c[0]&&(c[0]=0),null===c.at(-1)&&(c[c.length-1]=1);for(let t=0;t<c.length;t++){let e=c[t],a=t+1;for(;a<c.length&&null===c[a];)a++;let n=(c[a]-c[t])/(a-t);for(let i=1;i<a-t;i++)c[t+i]=n*i+e}const d=Math.PI*(n-90)/180,p=Math.cos(d),u=Math.sin(d),g=.5/Math.max(Math.abs(p),Math.abs(u)),m=.5-g*p,f=.5-g*u,h=.5+g*p,$=.5+g*u;I(`let gradient${r} = new LinearGradient()`),I(`gradient${r}.colors = [${l}]`),I(`gradient${r}.locations = [${c}]`),I(`gradient${r}.startPoint = new Point(${m}, ${f})`),I(`gradient${r}.endPoint = new Point(${h}, ${$})`),I(`${a}.backgroundGradient = gradient${r}`)},validate(t,e,a){let n=a.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).map((t=>t.trim()));(["to top","to top right","to right","to bottom right","to bottom","to bottom left","to left","to top left"].includes(n[0].toLowerCase())||/\d+\s*deg/.test(n[0]))&&n.shift(),n.length<2&&W("`{}` {} must have at least two color stops after the direction: `{}`.",t,e,a);let i=-1/0;for(const o of n){const n=o.match(/\s+(\d+(?:\.\d+)?%?)$/);if(n){const o=n[1],r=o.endsWith("%")?Number(o.slice(0,-1))/100:Number(o);Number.isFinite(r)||W("`{}` {} has invalid position: `{}` in `{}`.",t,e,o,a),(r<0||r>1)&&W("`{}` {} position must be between `0` and `1`: `{}`.",t,e,o),r<i&&W("`{}` {} color-stop positions must be in ascending order: `{}`.",t,e,a),i=r}}}},padding:{add(t,e,a){if("default"===e)return void I(`${a}.useDefaultPadding()`);const n=e.split(",").map((t=>parseInt(t.trim(),10)));let[i,o,r,s]=n;1===n.length?[i,o,r,s]=[i,i,i,i]:2===n.length?[i,o,r,s]=[i,o,i,o]:3===n.length&&([i,o,r,s]=[i,o,r,o]),I(`${a}.setPadding(${i}, ${o}, ${r}, ${s})`)},validate(t,e,a){if("default"===a)return;const n=a.split(",").map((t=>t.trim()));(n.length<1||n.length>4)&&W("`{}` {} must have 1-4 comma-separated positive integers or be `default`: `{}`.",t,e,a);for(let i of n)/^\d+$/.test(i)||W("`{}` {} must be non-negative integers: `{}` contains `{}`.",t,e,a,i)}},size:{add(t,e,a){let[n,i]=e.split(",");I(`${a}.${t} = new Size(${n}, ${i})`)},validate(t,e,a){/^\d+\s*,\s*\d+$/.test(a)||W("`{}` {} must be 2 positive integers separated by commas: `{}`.",t,e,a)}},font:{add(t,e,a){let n=/^(((black|bold|medium|light|heavy|regular|semibold|thin|ultraLight)(MonospacedSystemFont|RoundedSystemFont|SystemFont)\s*,\s*(\d+))|(body|callout|caption1|caption2|footnote|subheadline|headline|largeTitle|title1|title2|title3)|((italicSystemFont)\s*,\s*(\d+)))$/;if(n.test(e))I(`${a}.font = Font.${e.replace(n,"$3$4$6$8($5$9)")}`);else{const[t,n]=e.split(",");I(`${a}.font = new Font("${t.replace(/"/g,"")}",${n.match(/\d+/g)[0]})`)}},validate(t,e,a){/^[^,]+,\s*\d+$/.test(a)||["body","callout","caption1","caption2","footnote","subheadline","headline","italicSystemFont","largeTitle","title1","title2","title3"].includes(a)||W("`{}` {} must be 1 font name and 1 positive integer separated by commas or be a content-based font: `{}`.",t,e,a)}},point:{add(t,e,a){const[n,i]=e.split(",");I(`${a}.shadowOffset = new Point(${n},${i})`)},validate(t,e,a){/^-?\d+\s*,\s*-?\d+$/.test(a)||W("`{}` {} must be 2 integers separated by commas: `{}`.",t,e,a)}},bool:{add(t,e,a){"false"!==e&&I("resizable"===t?`${a}.resizable = false`:`${a}.${t} = true`)},validate(){}},url:{add:(t,e,a)=>{I(`${a}.url = "${e.replace(/"/g,"")}"`)},validate(t,e,a){/^https?:\/\/\S+$/.test(a)||W("`{}` {} must be a valid URL: `{}.`",t,e,a)}},image:{add(t,e,a){e.startsWith("data:image/")?I(`${a}.backgroundImage = Image.fromData(Data.fromBase64String("${e.split(",",2)[1].replace(/"/g,"")}"))`):I(`${a}.backgroundImage = await new Request("${e.replace(/"/g,"")}").loadImage()`)},validate(t,e,a){/^(https?:\/\/\S+|data:image\/\w+?;base64,[a-zA-Z0-9+/]+=*)$/.test(a)||W("`{}` {} must be a valid url or base encoded data link: `{}`.",t,e,a)}},layout:{add(t,e,a){I(`${a}.layout${x(e)}()`)},validate(t,e,a){"vertically"!==a&&"horizontally"!==a&&W("`{}` {} must be `vertically` or `horizontally`: `{}`.",t,e,a)}},alignText:{add(t,e,a){I(`${a}.${e}AlignText()`)},validate(t,e,a){["center","left","right"].includes(a)||W("`{}` {} must be `left`, `right` or `center`: `{}.`",t,e,a)}},alignImage:{add(t,e,a){I(`${a}.${e}AlignImage()`)},validate(t,e,a){["center","left","right"].includes(a)||W("`{}` {} must be `left`, `right` or `center`: `{}`.",t,e,a)}},alignContent:{add(t,e,a){I(`${a}.${e}AlignContent()`)},validate(t,e,a){["center","top","bottom"].includes(a)||W("`{}` {} must be `top`, `bottom` or `center`: `{}`.",t,e,a)}},applyStyle:{add(t,e,a){I(`${a}.apply${x(e)}Style()`)},validate(t,e,a){["date","timer","offset","relative","time"].includes(a)||W("`{}` {} must be `date`, `timer` , `relative`, `time`, or `offset`: `{}`.",t,e,a)}},contentMode:{add(t,e,a){I(`${a}.apply${x(e)}ContentMode()`)},validate(t,e,a){["filling","fitting"].includes(a)||W("`{}` {} must be `filling` or `fitting`: `{}`.",t,e,a)}}};await b(p),I("// Widget Complete"),e&&console.log(i);const g=new(0,Object.getPrototypeOf((async function(){})).constructor)(i+"\nreturn widget");return await g();function m(t){const e=[],a=new XMLParser(t),n={name:"root",children:[]},i=[n];return a.didStartElement=(t,a)=>{const n={name:t,attrs:a,innerText:"",children:[],classList:[]};"style"===t?e.push(n):i.at(-1).children.push(n),i.push(n)},a.foundCharacters=t=>{const e=i.at(-1);e.innerText+=""===e.innerText?t:" "+t},a.didEndElement=()=>{const t=i.pop();t.classList=t.attrs.class?t.attrs.class.trim().split(/\s+/):[],0===i.length&&W("Unexpected closing tag: <{}/>",t.name)},a.parseErrorOccurred=t=>{W("A parse error occurred: {}",t)},a.parse(),1!==i.length&&W("A parse error occurred, ensure all tags are closed and attributes are properly formatted: <{}>",i.at(-1).name),{root:n,styleTags:e}}function f(t){return t.replace(/\s/g,"").split(">").filter((t=>t.length)).map((t=>{let e,a=t;if(!t.startsWith(".")){const n=t.match(/^([a-zA-Z][\w-]*|\*)/);n?(e=n[1],a=t.slice(e.length)):W("A css parse error occurred, invalid tag name: {}.",t)}const n=[];let i;const o=/\.([-_a-zA-Z0-9]+)/g;for(;i=o.exec(a);)n.push(i[1]);return{tag:e,classes:n}}))}function h(t,e,a,n){for(const i of e){const[e,...o]=i.selector;$(t,e)&&(0===o.length?a.push(i):n.push({selector:o,css:i.css}))}}function $(t,{tag:e,classes:a}){return(!e||"*"===e||t.name===e)&&a.every((e=>t.classList.includes(e)))}async function b(t){"widget"==t.name&&i&&W("`widget` tag must not be nestled."),i&&I(""),t.name in o?o[t.name]+=1:o[t.name]=0;const e=o[t.name],r=t.innerText.replace(/&lt;/g,"<").replace(/&gt/g,">").replace(/&amp;/g,"&").replace(/\n\s+/g,"\\n"),l=(c=t.attrs,Object.fromEntries(Object.entries(c).filter((([t])=>!["class","no-css","children"].includes(t))).map((([t,e])=>[T(t),e.trim()]))));var c;const d=function(t=[],e,a){if(null!=a)return{...e};const n={};for(const{css:e}of t)Object.assign(n,e);return{...n,...e}}(t.css,l,t.attrs["no-css"]),p={widget:{mapping:{background:["gradient","image","colour"],refreshAfterDate:"posInt",spacing:"posInt",url:"url",padding:"padding",addAccessoryWidgetBackground:"bool"},hasChildren:!0,instantiate:()=>(I("let widget = new ListWidget()"),"widget"),async applyStyles(t){const{background:e,...a}=d,n=e in l?"attribute":"property";await w("widget",n,e),await y(t,a,this.mapping)}},stack:{mapping:{background:["gradient","image","colour"],spacing:"posInt",url:"url",padding:"padding",borderColor:"colour",borderWidth:"posInt",size:"size",cornerRadius:"posInt",alignContent:"alignContent",layout:"layout"},hasChildren:!0,instantiate:()=>(I(`let stack${e} = ${n}.addStack()`),`stack${e}`),async applyStyles(t){const{background:e,...a}=d,n=e in l?"attribute":"property";await w(t,n,e),await y(t,a,this.mapping)}},spacer:{mapping:{space:"posInt"},hasChildren:!1,instantiate(){const t=l.space&&"null"!==l.space?l.space:"";return I(`let spacer${e} = ${n}.addSpacer(${t})`),null}},text:{mapping:{url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText"},hasChildren:!1,instantiate:()=>(I(`let text${e} = ${n}.addText("${r.replace(/"/g,"")}")`),`text${e}`),async applyStyles(t){await y(t,d,this.mapping)}},date:{mapping:{url:"url",font:"font",lineLimit:"posInt",minimumScaleFactor:"decimal",shadowColor:"colour",shadowOffset:"point",shadowRadius:"posInt",textColor:"colour",textOpacity:"decimal",alignText:"alignText",applyStyle:"applyStyle"},hasChildren:!1,instantiate:()=>(I(`let date${e} = ${n}.addDate(new Date("${r.replace(/"/g,"")}"))`),`date${e}`),async applyStyles(t){await y(t,d,this.mapping)}},img:{mapping:{src:"image",url:"url",borderColor:"colour",borderWidth:"posInt",cornerRadius:"posInt",imageSize:"size",imageOpacity:"decimal",tintColor:"colour",resizable:"bool",containerRelativeShape:"bool",contentMode:"contentMode",alignImage:"alignImage"},hasChildren:!1,instantiate(){let t;return l.src&&"null"!==l.src||W("`img` tag must have a `src` attribute."),t=l.src.startsWith("data:image/")?`Image.fromData(Data.fromBase64String("${l.src.replace(/data:image\/.*?;base64,/,"").replace(/"/g,"")}"))`:`await new Request("${l.src.replace(/"/g,"")}").loadImage()`,I(`let img${e} = ${n}.addImage(${t})`),`img${e}`},async applyStyles(t){const{src:e,...a}=d;await y(t,a,this.mapping)}}},u=p[t.name];if(!u){t.name in a||W("Invalid tag name: `{}`.",t.name),I(`// <${t.name}>`);const e=a[t.name],i=e.mapping||{};C(l,d,i);for(let t in i)t in d||(d[t]="null"),t in l||(l[t]="null");const o=e=>async function(t,e){let{root:a}=m(t);a.children.forEach((t=>v(t,e))),s++;const i=n;for(let t of a.children)n=i,await b(t);s--}(e,t.children);return await e.render(o,d,l,r),void I(`// </${t.name}>`)}const g=u.instantiate();if(C(l,d,u.mapping),await(u.applyStyles?.(g)),u.hasChildren){s++;const e=n;n=g;for(const e of t.children)await b(e);s--,n=e}}async function y(t,e,a){for(const[n,i]of Object.entries(e)){if("null"===i)continue;const e=a[n];await u[e].add(n,i,t)}}async function w(t,e,a){if(a&&"null"!==a)try{u.url.validate("background","attribute",a),u.image.add("background",a,t)}catch{1===a.split(/,(?![^(]*\))(?![^"']*["'](?:[^"']*["'][^"']*["'])*[^"']*$)/).length?await u.colour.add("backgroundColor",a,t):(u.gradient.validate("backgroundGradient",e,a),await u.gradient.add("backgroundGradient",a,t))}}function v(t,e){t.attrs["no-css"]="";for(let a of t.children||[])v(a,e);"children"in t.attrs&&t.children.push(...e)}function C(t,e,a){S(t,a,"attribute"),S(e,a,"property")}function S(t,e,a){for(const[n,i]of Object.entries(t)){const o=e[n];if(!o){if("property"===a){delete t[n];continue}W("Unknown attribute: `{}`.",attr)}if("null"===i)continue;if(!Array.isArray(o)){u[o].validate(n,a,i);continue}if(!o.some((t=>{try{return u[t].validate(n,a,i),!0}catch{return!1}}))){const t=o.join(", ").replace(/,([^,]+)$/," or$1");W("`{}` {} must be {} type: `{}`",n,a,t,i)}}}function I(t){const e=" ".repeat(s);i+=`\n${e+t}`}function x(t){return t[0].toUpperCase()+t.slice(1)}async function k(t){if(l.has(t))return l.get(t);let e=new WebView;await e.loadHTML(`<div id="div"style="color:${t}"></div>`);const a=function(t,e,a,n=1){const i=t=>t.toString(16).padStart(2,"0"),o=1===n?"":`,${n}`;return`new Color("#${i(t)}${i(e)}${i(a)}"${o})`}(...(await e.evaluateJavaScript('window.getComputedStyle(document.getElementById("div")).color')).match(/\d+(\.\d+)?/g).map(Number));return l.set(t,a),a}function T(t){return t.replace(/-(.)/g,((t,e)=>e.toUpperCase()))}function W(t,...e){for(let a of e)t=t.replace("{}",a);throw new Error(`HTML Widget Error\n--------<Code>--------\n${i}\n--------</Code>--------\n${t}`)}}module.exports=htmlWidget;